name: Build and Deploy to Production

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/xmgamer

jobs:
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./XMGamer
          file: ./XMGamer/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-platform-api:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-platform-api:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to Server
    needs: build-and-push
    runs-on: ubuntu-latest
    if: needs.build-and-push.result == 'success' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create .env file
        run: |
          cat > .env << EOF
          # æ•°æ®åº“é…ç½®
          MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}
          MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}
          MYSQL_USER=${{ secrets.MYSQL_USER }}
          MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}
          
          # Redis é…ç½®
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          
          # Flask åº”ç”¨é…ç½®
          FLASK_ENV=production
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
          
          # æ¸¸æˆ API é…ç½®
          DEEPSEEK_API_KEY=${{ secrets.DEEPSEEK_API_KEY }}
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          
          # Vector Engine AI é…ç½®ï¼ˆç™»å½•é¡µAIå¯¹è¯ï¼‰
          VECTORAPI_KEY=${{ secrets.VECTORAPI_KEY }}
          VECTORAPI_BASE_URL=https://api.vectorengine.ai/v1
          VECTORAPI_MODEL=gpt-4o-mini
          
          # çŸ­ä¿¡æœåŠ¡é…ç½®
          ALIYUN_ACCESS_KEY_ID=${{ secrets.ALIYUN_ACCESS_KEY_ID }}
          ALIYUN_ACCESS_KEY_SECRET=${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}
          ALIYUN_SMS_SIGN_NAME=${{ secrets.ALIYUN_SMS_SIGN_NAME }}
          ALIYUN_SMS_TEMPLATE_CODE=${{ secrets.ALIYUN_SMS_TEMPLATE_CODE }}
          
          # é‚®ä»¶æœåŠ¡é…ç½®
          SENDGRID_API_KEY=${{ secrets.SENDGRID_API_KEY }}
          SENDGRID_FROM_EMAIL=${{ secrets.SENDGRID_FROM_EMAIL }}
          
          # å¾®ä¿¡ç™»å½•é…ç½®
          WECHAT_APP_ID=${{ secrets.WECHAT_APP_ID }}
          WECHAT_APP_SECRET=${{ secrets.WECHAT_APP_SECRET }}
          
          # æ”¯ä»˜é…ç½®
          ALIPAY_APP_ID=${{ secrets.ALIPAY_APP_ID }}
          ALIPAY_PRIVATE_KEY=${{ secrets.ALIPAY_PRIVATE_KEY }}
          ALIPAY_PUBLIC_KEY=${{ secrets.ALIPAY_PUBLIC_KEY }}
          WECHAT_PAY_MCH_ID=${{ secrets.WECHAT_PAY_MCH_ID }}
          WECHAT_PAY_API_KEY=${{ secrets.WECHAT_PAY_API_KEY }}
          
          # åŸŸåé…ç½®
          DOMAIN=${{ secrets.DOMAIN }}
          API_DOMAIN=${{ secrets.API_DOMAIN }}
          GAME_WITCH_DOMAIN=${{ secrets.GAME_WITCH_DOMAIN }}
          
          # æœåŠ¡å™¨é…ç½®
          PLATFORM_API_PORT=5000
          GAME_WITCH_PORT=5001
          
          # æ—¥å¿—é…ç½®
          LOG_LEVEL=INFO
          LOG_FILE_MAX_BYTES=10485760
          LOG_FILE_BACKUP_COUNT=10
          
          # å®‰å…¨é…ç½®
          CORS_ORIGINS=${{ secrets.CORS_ORIGINS }}
          SESSION_LIFETIME=86400
          JWT_ACCESS_TOKEN_EXPIRES=3600
          JWT_REFRESH_TOKEN_EXPIRES=2592000
          
          # æ€§èƒ½é…ç½®
          DB_POOL_SIZE=10
          DB_MAX_OVERFLOW=20
          REDIS_POOL_SIZE=10
          WORKERS=4
          
          # å¼€å‘/è°ƒè¯•é…ç½®
          DEBUG=false
          TESTING=false
          
          # å¤‡ä»½é…ç½®
          BACKUP_ENABLED=true
          BACKUP_SCHEDULE=0 2 * * *
          BACKUP_RETENTION_DAYS=7
          EOF
      
      - name: Create docker-compose.prod.yml
        run: |
          cat > docker-compose.prod.yml << 'EOF'
          version: '3.8'
          
          services:
            nginx:
              image: nginx:alpine
              container_name: xmgamer-gateway
              restart: always
              ports:
                - "80:80"
                - "443:443"
              volumes:
                - ./nginx/conf.d:/etc/nginx/conf.d:ro
                - ./nginx/ssl:/etc/nginx/ssl:ro
                - ./logs/nginx:/var/log/nginx
                - ./XMGamer/frontend:/usr/share/nginx/html/platform:ro
              depends_on:
                - platform-api
              networks:
                - xmgamer-net
          
            mysql:
              image: mysql:8.0
              container_name: xmgamer-db
              restart: always
              environment:
                MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
                MYSQL_DATABASE: ${MYSQL_DATABASE}
                MYSQL_USER: ${MYSQL_USER}
                MYSQL_PASSWORD: ${MYSQL_PASSWORD}
                TZ: Asia/Shanghai
              volumes:
                - ./data/mysql:/var/lib/mysql
              networks:
                - xmgamer-net
              command: 
                - --character-set-server=utf8mb4
                - --collation-server=utf8mb4_unicode_ci
                - --max_connections=500
                - --innodb_buffer_pool_size=1G
          
            redis:
              image: redis:7-alpine
              container_name: xmgamer-redis
              restart: always
              command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
              volumes:
                - ./data/redis:/data
              networks:
                - xmgamer-net
          
            platform-api:
              image: ghcr.io/${{ github.repository_owner }}/xmgamer-platform-api:latest
              container_name: xmgamer-api
              restart: always
              environment:
                DB_HOST: mysql
                DB_PORT: 3306
                DB_NAME: ${MYSQL_DATABASE}
                DB_USER: ${MYSQL_USER}
                DB_PASSWORD: ${MYSQL_PASSWORD}
                REDIS_HOST: redis
                REDIS_PORT: 6379
                REDIS_PASSWORD: ${REDIS_PASSWORD}
                FLASK_ENV: production
                SECRET_KEY: ${SECRET_KEY}
                JWT_SECRET_KEY: ${JWT_SECRET_KEY}
                VECTORAPI_KEY: ${VECTORAPI_KEY}
                VECTORAPI_BASE_URL: ${VECTORAPI_BASE_URL}
                VECTORAPI_MODEL: ${VECTORAPI_MODEL}
                PORT: 5000
                TZ: Asia/Shanghai
              volumes:
                - ./logs/platform:/app/logs
              depends_on:
                - mysql
                - redis
              networks:
                - xmgamer-net
          
          
          networks:
            xmgamer-net:
              driver: bridge
          EOF
      
      - name: Copy configuration files to server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          source: ".env,docker-compose.prod.yml,nginx/,XMGamer/frontend/"
          target: ${{ secrets.DEPLOY_PATH || '/var/www/FrameWorker' }}
          strip_components: 0
      
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd ${{ secrets.DEPLOY_PATH || '/var/www/FrameWorker' }}
            
            # åˆ›å»ºå¿…è¦çš„ç›®å½•
            mkdir -p data/mysql data/redis logs/nginx logs/platform logs/game-witch nginx/ssl backups vector_db
            
            # ç™»å½•åˆ°GitHub Container Registry
            echo "ç™»å½•åˆ°GitHub Container Registry..."
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # æ‹‰å–æœ€æ–°é•œåƒ
            echo "æ‹‰å–æœ€æ–°é•œåƒ..."
            docker pull ghcr.io/${{ github.repository_owner }}/xmgamer-platform-api:latest
            
            # åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨
            echo "åœæ­¢æ—§å®¹å™¨..."
            docker-compose -f docker-compose.prod.yml down 2>/dev/null || true
            
            # ä½¿ç”¨docker-composeå¯åŠ¨æ‰€æœ‰æœåŠ¡
            echo "å¯åŠ¨æœåŠ¡..."
            docker-compose -f docker-compose.prod.yml up -d
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 15
            
            # æ˜¾ç¤ºè¿è¡ŒçŠ¶æ€
            echo "å®¹å™¨è¿è¡ŒçŠ¶æ€ï¼š"
            docker-compose -f docker-compose.prod.yml ps
            
            # æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
            docker image prune -af
      
      - name: Health check
        run: |
          echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 30
          
          # æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€ï¼ˆå¦‚æœå¤±è´¥ä¸ä¸­æ–­éƒ¨ç½²ï¼‰
          if curl -f http://${{ secrets.SERVER_HOST }}/health 2>/dev/null; then
            echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡ï¼æœåŠ¡è¿è¡Œæ­£å¸¸"
          else
            echo "âš ï¸ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œä½†å®¹å™¨å¯èƒ½ä»åœ¨å¯åŠ¨ä¸­"
            echo "è¯·æ‰‹åŠ¨éªŒè¯æœåŠ¡çŠ¶æ€"
          fi

  notify:
    name: Send Notification
    needs: deploy
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Send deployment notification
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
            echo "åˆ†æ”¯: ${{ github.ref_name }}"
            echo "æäº¤: ${{ github.sha }}"
            echo "ä½œè€…: ${{ github.actor }}"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
            echo "è¯·æ£€æŸ¥æ—¥å¿—"
          fi