name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²è®°å½•

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          ssh $SERVER_USER@$SERVER_HOST "bash -s" << EOF
            set -e

            echo "ðŸš€ Starting deployment..."

            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd $DEPLOY_PATH

            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "ðŸ“¥ Pulling latest code..."
            git fetch origin
            git reset --hard origin/main

            # æ›´æ–° .env æ–‡ä»¶ä¸­çš„ API å¯†é’¥
            echo "ðŸ”‘ Updating API key in .env..."
            if [ -f "MaxGamer/backend/.env" ]; then
              sed -i "s|VECTORAPI_KEY=.*|VECTORAPI_KEY=$DEEPSEEK_API_KEY|g" MaxGamer/backend/.env
              echo "âœ… API key updated"
            else
              echo "âš ï¸  .env file not found at MaxGamer/backend/.env"
            fi

            # èµ‹äºˆéƒ¨ç½²è„šæœ¬æ‰§è¡Œæƒé™
            chmod +x deploy.sh

            # æ‰§è¡Œéƒ¨ç½²
            echo "âš™ï¸ Running deployment script..."
            ./deploy.sh --skip-backup

            echo "âœ… Deployment completed successfully!"
          EOF

      - name: Verify deployment
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          ssh $SERVER_USER@$SERVER_HOST "bash -s" << EOF
            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd $DEPLOY_PATH

            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
            docker-compose -f docker-compose.isolated.yml ps

            # æ£€æŸ¥ API å¥åº·çŠ¶æ€
            curl -f http://localhost:3000/api/health || exit 1

            echo "ðŸŽ‰ Deployment verified successfully!"
          EOF

      - name: Send notification
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "âœ… Deployment successful!"
          else
            echo "âŒ Deployment failed!"
          fi
