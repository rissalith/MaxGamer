<!-- ç”¨æˆ·ç®¡ç†é¡µé¢ (ç®¡ç†å‘˜) -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
<style>
    .admin-users-page {
        padding: 24px;
        font-family: 'Noto Sans SC', sans-serif;
        background: var(--content-bg, #f8f9fa);
        min-height: 100%;
    }
    
    .page-header {
        background: var(--content-card-bg, #fff);
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .page-header h1 {
        font-size: 24px;
        font-weight: 700;
        margin: 0 0 8px 0;
        background: var(--header-title-gradient, linear-gradient(135deg, #667eea 0%, #764ba2 100%));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .page-header p {
        color: var(--content-text-secondary, #5f6368);
        margin: 0;
    }
    
    .toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        gap: 16px;
        flex-wrap: wrap;
    }
    
    .search-box {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
        max-width: 400px;
    }
    
    .search-box input {
        flex: 1;
        padding: 10px 16px;
        border: 1px solid var(--input-border, #dadce0);
        border-radius: 8px;
        font-size: 14px;
        background: var(--input-bg, #fff);
        color: var(--content-text, #202124);
    }
    
    .search-box input:focus {
        outline: none;
        border-color: var(--input-focus-border, #1a73e8);
    }
    
    .btn-search {
        padding: 10px 16px;
        background: var(--btn-secondary-bg, #f1f3f4);
        border: none;
        border-radius: 8px;
        cursor: pointer;
        color: var(--content-text, #202124);
    }
    
    .btn-search:hover {
        background: #e8eaed;
    }
    
    .btn-primary {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        background: var(--btn-primary-bg, #1a73e8);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .btn-primary:hover {
        filter: brightness(0.9);
        transform: translateY(-1px);
    }
    
    .btn-primary svg {
        width: 18px;
        height: 18px;
    }
    
    /* ç”¨æˆ·è¡¨æ ¼ */
    .users-table-container {
        background: var(--content-card-bg, #fff);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .users-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .users-table th,
    .users-table td {
        padding: 14px 16px;
        text-align: left;
        border-bottom: 1px solid var(--content-border, #e8eaed);
    }
    
    .users-table th {
        background: var(--table-header-bg, #f8f9fa);
        font-weight: 600;
        color: var(--content-text, #202124);
        font-size: 13px;
    }
    
    .users-table td {
        color: var(--content-text, #202124);
        font-size: 14px;
    }
    
    .users-table tr:hover {
        background: var(--table-row-hover, #f8f9fa);
    }
    
    .user-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--card-gradient, linear-gradient(135deg, #667eea 0%, #764ba2 100%));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 16px;
    }
    
    .user-avatar img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
    }
    
    .user-details {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    
    .user-nickname {
        font-weight: 500;
        font-size: 14px;
        color: var(--content-text, #202124);
    }
    
    .user-email {
        font-size: 12px;
        color: var(--content-text-secondary, #5f6368);
    }
    
    .role-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
    }
    
    .role-admin { background: #e8f5e9; color: #1b5e20; }
    .role-creator { background: #e3f2fd; color: #1565c0; }
    .role-user { background: #f5f5f5; color: #616161; }
    
    .status-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
    }
    
    .status-active { background: #e8f5e9; color: #1b5e20; }
    .status-banned { background: #ffebee; color: #c62828; }
    .status-suspended { background: #fff3e0; color: #e65100; }
    
    .balance-cell {
        font-weight: 600;
        color: var(--btn-primary-bg, #1a73e8);
    }
    
    .action-btns {
        display: flex;
        gap: 8px;
    }
    
    .btn-action {
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .btn-edit { background: var(--btn-secondary-bg, #f1f3f4); color: var(--content-text, #202124); }
    .btn-edit:hover { background: #e8eaed; }
    .btn-points { background: #e3f2fd; color: #1565c0; }
    .btn-points:hover { background: #bbdefb; }
    .btn-delete { background: #ffebee; color: #c62828; }
    .btn-delete:hover { background: #ffcdd2; }
    
    /* åˆ†é¡µ */
    .pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px;
        border-top: 1px solid var(--content-border, #e8eaed);
    }
    
    .pagination-info {
        font-size: 14px;
        color: var(--content-text-secondary, #5f6368);
    }
    
    .pagination-btns {
        display: flex;
        gap: 8px;
    }
    
    .btn-page {
        padding: 8px 12px;
        border: 1px solid var(--content-border, #dadce0);
        background: var(--content-card-bg, #fff);
        border-radius: 6px;
        cursor: pointer;
        color: var(--content-text, #202124);
    }
    
    .btn-page:hover:not(:disabled) {
        background: var(--btn-secondary-bg, #f1f3f4);
    }
    
    .btn-page:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    /* æ¨¡æ€æ¡† */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 10000;
        justify-content: center;
        align-items: center;
    }
    
    .modal.active { display: flex; }
    
    .modal-dialog {
        background: var(--content-card-bg, #fff);
        border-radius: 16px;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    
    .modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--content-border, #e8eaed);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-header h2 {
        margin: 0;
        font-size: 18px;
        color: var(--content-text, #202124);
    }
    
    .btn-close {
        background: none;
        border: none;
        padding: 8px;
        cursor: pointer;
        color: var(--content-text-secondary, #5f6368);
        border-radius: 50%;
    }
    
    .btn-close:hover { background: var(--btn-secondary-bg, #f1f3f4); }
    
    .modal-body {
        padding: 24px;
        overflow-y: auto;
        flex: 1;
    }
    
    .form-group {
        margin-bottom: 16px;
    }
    
    .form-group label {
        display: block;
        font-size: 13px;
        font-weight: 500;
        color: var(--content-text, #202124);
        margin-bottom: 6px;
    }
    
    .form-group input,
    .form-group select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--input-border, #dadce0);
        border-radius: 8px;
        font-size: 14px;
        background: var(--input-bg, #fff);
        color: var(--content-text, #202124);
        box-sizing: border-box;
    }
    
    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: var(--input-focus-border, #1a73e8);
    }
    
    .form-group textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--input-border, #dadce0);
        border-radius: 8px;
        font-size: 14px;
        background: var(--input-bg, #fff);
        color: var(--content-text, #202124);
        box-sizing: border-box;
        resize: vertical;
        min-height: 80px;
    }
    
    .form-row {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }
    
    .modal-footer {
        padding: 16px 24px;
        border-top: 1px solid var(--content-border, #e8eaed);
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }
    
    .btn-cancel {
        padding: 10px 20px;
        border: 1px solid var(--content-border, #dadce0);
        background: var(--content-card-bg, #fff);
        color: var(--content-text, #202124);
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
    }
    
    .btn-submit {
        padding: 10px 20px;
        background: var(--btn-primary-bg, #1a73e8);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
    }
    
    .btn-submit:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    /* ç»Ÿè®¡å¡ç‰‡ */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }
    
    .stat-card {
        background: var(--content-card-bg, #fff);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        display: flex;
        align-items: center;
        gap: 16px;
    }
    
    .stat-card-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        flex-shrink: 0;
    }
    
    .stat-card-content {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    
    .stat-card-title {
        font-size: 13px;
        color: var(--content-text-secondary, #5f6368);
    }
    
    .stat-card-value {
        font-size: 24px;
        font-weight: 700;
        color: var(--content-text, #202124);
    }
    
    .stat-users { background: #e3f2fd; }
    .stat-creators { background: #e8f5e9; }
    .stat-admins { background: #fff3e0; }
    .stat-balance { background: #f3e5f5; }
    
    /* ç©ºçŠ¶æ€ */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
    }
    
    .empty-state svg {
        width: 64px;
        height: 64px;
        color: var(--content-text-secondary, #5f6368);
        margin-bottom: 16px;
    }
    
    .empty-state h3 {
        margin: 0 0 8px 0;
        color: var(--content-text, #202124);
    }
    
    .empty-state p {
        margin: 0;
        color: var(--content-text-secondary, #5f6368);
    }
</style>

<div class="admin-users-page">
    <div class="page-header">
        <h1>ç”¨æˆ·ç®¡ç†</h1>
        <p>ç®¡ç†å¹³å°æ‰€æœ‰æ³¨å†Œè´¦å·ã€æƒé™å’Œç‚¹æ•°</p>
    </div>
    
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-card-icon stat-users">ğŸ‘¥</div>
            <div class="stat-card-content">
                <div class="stat-card-title">æ€»ç”¨æˆ·æ•°</div>
                <div class="stat-card-value" id="statTotalUsers">-</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-card-icon stat-creators">ğŸ®</div>
            <div class="stat-card-content">
                <div class="stat-card-title">åˆ›ä½œè€…</div>
                <div class="stat-card-value" id="statCreators">-</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-card-icon stat-admins">ğŸ‘‘</div>
            <div class="stat-card-content">
                <div class="stat-card-title">ç®¡ç†å‘˜</div>
                <div class="stat-card-value" id="statAdmins">-</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-card-icon stat-balance">ğŸ’°</div>
            <div class="stat-card-content">
                <div class="stat-card-title">å¹³å°æ€»ç‚¹æ•°</div>
                <div class="stat-card-value" id="statTotalBalance">-</div>
            </div>
        </div>
    </div>
    
    <div class="toolbar">
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="æœç´¢é‚®ç®±ã€æ˜µç§°æˆ–æ‰‹æœºå·...">
            <button class="btn-search" onclick="AdminUsers.search()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                </svg>
            </button>
        </div>
        <button class="btn-primary" onclick="AdminUsers.openCreateModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            æ·»åŠ ç”¨æˆ·
        </button>
    </div>
    
    <div class="users-table-container">
        <table class="users-table">
            <thead>
                <tr>
                    <th>ç”¨æˆ·</th>
                    <th>è§’è‰²</th>
                    <th>çŠ¶æ€</th>
                    <th>ç‚¹æ•°ä½™é¢</th>
                    <th>æ³¨å†Œæ—¶é—´</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="usersTableBody">
                <!-- ç”¨æˆ·æ•°æ®å°†åŠ¨æ€æ¸²æŸ“ -->
            </tbody>
        </table>
        
        <div class="empty-state" id="emptyState" style="display: none;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
            <h3>æš‚æ— ç”¨æˆ·</h3>
            <p>è¿˜æ²¡æœ‰æ³¨å†Œç”¨æˆ·</p>
        </div>
        
        <div class="pagination" id="pagination">
            <div class="pagination-info" id="paginationInfo">æ˜¾ç¤º 0-0 å…± 0 æ¡</div>
            <div class="pagination-btns">
                <button class="btn-page" id="btnPrev" onclick="AdminUsers.prevPage()" disabled>ä¸Šä¸€é¡µ</button>
                <button class="btn-page" id="btnNext" onclick="AdminUsers.nextPage()" disabled>ä¸‹ä¸€é¡µ</button>
            </div>
        </div>
    </div>
</div>

<!-- åˆ›å»º/ç¼–è¾‘ç”¨æˆ·æ¨¡æ€æ¡† -->
<div class="modal" id="userModal">
    <div class="modal-dialog">
        <div class="modal-header">
            <h2 id="modalTitle">æ·»åŠ ç”¨æˆ·</h2>
            <button class="btn-close" onclick="AdminUsers.closeModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="editUserId">
            
            <div class="form-group">
                <label>é‚®ç®± *</label>
                <input type="email" id="userEmail" placeholder="user@example.com">
            </div>
            
            <div class="form-group">
                <label>æ‰‹æœºå·</label>
                <input type="tel" id="userPhone" placeholder="13800138000">
            </div>
            
            <div class="form-group">
                <label>æ˜µç§°</label>
                <input type="text" id="userNickname" placeholder="ç”¨æˆ·æ˜µç§°">
            </div>
            
            <div class="form-group" id="passwordGroup">
                <label>å¯†ç </label>
                <input type="password" id="userPassword" placeholder="ç•™ç©ºåˆ™ä¸ä¿®æ”¹å¯†ç ">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>è§’è‰²</label>
                    <select id="userRole">
                        <option value="user">æ™®é€šç”¨æˆ·</option>
                        <option value="creator">åˆ›ä½œè€…</option>
                        <option value="admin">ç®¡ç†å‘˜</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>çŠ¶æ€</label>
                    <select id="userStatus">
                        <option value="active">æ­£å¸¸</option>
                        <option value="banned">å°ç¦</option>
                        <option value="suspended">æš‚åœ</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group" id="balanceGroup" style="display: none;">
                <label>åˆå§‹ç‚¹æ•°</label>
                <input type="number" id="userBalance" value="0" min="0">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="AdminUsers.closeModal()">å–æ¶ˆ</button>
            <button class="btn-submit" id="btnSaveUser" onclick="AdminUsers.saveUser()">ä¿å­˜</button>
        </div>
    </div>
</div>

<!-- è°ƒæ•´ç‚¹æ•°æ¨¡æ€æ¡† -->
<div class="modal" id="pointsModal">
    <div class="modal-dialog">
        <div class="modal-header">
            <h2>è°ƒæ•´ç‚¹æ•°</h2>
            <button class="btn-close" onclick="AdminUsers.closePointsModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="pointsUserId">
            
            <div class="form-group">
                <label>ç”¨æˆ·</label>
                <input type="text" id="pointsUserInfo" disabled>
            </div>
            
            <div class="form-group">
                <label>å½“å‰ä½™é¢</label>
                <input type="text" id="pointsCurrentBalance" disabled>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>æ“ä½œç±»å‹</label>
                    <select id="pointsAction" onchange="AdminUsers.updatePointsPreview()">
                        <option value="add">å¢åŠ ç‚¹æ•°</option>
                        <option value="subtract">æ‰£é™¤ç‚¹æ•°</option>
                        <option value="set">ç›´æ¥è®¾ç½®</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æ•°é‡</label>
                    <input type="number" id="pointsAmount" value="0" min="0" onchange="AdminUsers.updatePointsPreview()">
                </div>
            </div>
            
            <div class="form-group">
                <label>è°ƒæ•´åä½™é¢</label>
                <input type="text" id="pointsNewBalance" disabled style="font-weight: 600; color: #1a73e8;">
            </div>
            
            <div class="form-group">
                <label>è°ƒæ•´åŸå› </label>
                <textarea id="pointsReason" placeholder="è¯·è¾“å…¥è°ƒæ•´åŸå› ï¼ˆå¦‚ï¼šé€€æ¬¾ã€è¡¥å¿ã€æµ‹è¯•ç­‰ï¼‰"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="AdminUsers.closePointsModal()">å–æ¶ˆ</button>
            <button class="btn-submit" onclick="AdminUsers.adjustPoints()">ç¡®è®¤è°ƒæ•´</button>
        </div>
    </div>
</div>

<script>
const AdminUsers = {
    users: [],
    currentPage: 0,
    pageSize: 20,
    total: 0,
    searchKeyword: '',
    
    async init() {
        console.log('[AdminUsers] åˆå§‹åŒ–...');
        
        // ç»‘å®šæœç´¢å›è½¦äº‹ä»¶
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.search();
        });
        
        await this.loadUsers();
        await this.loadStats();
    },
    
    async loadStats() {
        try {
            const response = await AuthManager.authenticatedFetch(
                `${AuthManager.apiBaseUrl}/admin/stats`
            );
            const data = await response.json();
            
            if (data.success) {
                document.getElementById('statTotalUsers').textContent = data.stats.users.total;
                document.getElementById('statAdmins').textContent = data.stats.users.admins;
                
                // è®¡ç®—åˆ›ä½œè€…æ•°é‡éœ€è¦ä»ç”¨æˆ·åˆ—è¡¨ä¸­ç»Ÿè®¡
                // æš‚æ—¶æ˜¾ç¤º "-"
                document.getElementById('statCreators').textContent = '-';
                document.getElementById('statTotalBalance').textContent = '-';
            }
        } catch (error) {
            console.error('[AdminUsers] åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
        }
    },
    
    async loadUsers() {
        try {
            const offset = this.currentPage * this.pageSize;
            let url = `${AuthManager.apiBaseUrl}/admin/users?limit=${this.pageSize}&offset=${offset}`;
            
            if (this.searchKeyword) {
                url += `&search=${encodeURIComponent(this.searchKeyword)}`;
            }
            
            const response = await AuthManager.authenticatedFetch(url);
            const data = await response.json();
            
            if (data.success) {
                this.users = data.users;
                this.total = data.total;
                this.renderUsers();
                this.updatePagination();
            }
        } catch (error) {
            console.error('[AdminUsers] åŠ è½½ç”¨æˆ·å¤±è´¥:', error);
        }
    },
    
    renderUsers() {
        const tbody = document.getElementById('usersTableBody');
        const empty = document.getElementById('emptyState');
        const pagination = document.getElementById('pagination');
        
        if (this.users.length === 0) {
            tbody.innerHTML = '';
            empty.style.display = 'block';
            pagination.style.display = 'none';
            return;
        }
        
        empty.style.display = 'none';
        pagination.style.display = 'flex';
        
        tbody.innerHTML = this.users.map(user => `
            <tr>
                <td>
                    <div class="user-info">
                        <div class="user-avatar">
                            ${user.avatar_url 
                                ? `<img src="${user.avatar_url}" alt="${user.nickname}">`
                                : (user.nickname ? user.nickname[0].toUpperCase() : 'U')
                            }
                        </div>
                        <div class="user-details">
                            <span class="user-nickname">${user.nickname || 'æœªè®¾ç½®'}</span>
                            <span class="user-email">${user.email || user.phone || 'ID: ' + user.id}</span>
                        </div>
                    </div>
                </td>
                <td>
                    <span class="role-badge role-${user.role}">${this.getRoleText(user.role)}</span>
                </td>
                <td>
                    <span class="status-badge status-${user.status}">${this.getStatusText(user.status)}</span>
                </td>
                <td class="balance-cell">${user.balance || 0} MP</td>
                <td>${this.formatDate(user.created_at)}</td>
                <td>
                    <div class="action-btns">
                        <button class="btn-action btn-edit" onclick="AdminUsers.editUser(${user.id})">ç¼–è¾‘</button>
                        <button class="btn-action btn-points" onclick="AdminUsers.openPointsModal(${user.id})">ç‚¹æ•°</button>
                        <button class="btn-action btn-delete" onclick="AdminUsers.deleteUser(${user.id})">åˆ é™¤</button>
                    </div>
                </td>
            </tr>
        `).join('');
    },
    
    getRoleText(role) {
        const texts = { 'user': 'ç”¨æˆ·', 'creator': 'åˆ›ä½œè€…', 'admin': 'ç®¡ç†å‘˜' };
        return texts[role] || role;
    },
    
    getStatusText(status) {
        const texts = { 'active': 'æ­£å¸¸', 'banned': 'å°ç¦', 'suspended': 'æš‚åœ' };
        return texts[status] || status;
    },
    
    formatDate(dateStr) {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        return date.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' });
    },
    
    updatePagination() {
        const start = this.currentPage * this.pageSize + 1;
        const end = Math.min((this.currentPage + 1) * this.pageSize, this.total);
        
        document.getElementById('paginationInfo').textContent = 
            `æ˜¾ç¤º ${this.total > 0 ? start : 0}-${end} å…± ${this.total} æ¡`;
        
        document.getElementById('btnPrev').disabled = this.currentPage === 0;
        document.getElementById('btnNext').disabled = end >= this.total;
    },
    
    prevPage() {
        if (this.currentPage > 0) {
            this.currentPage--;
            this.loadUsers();
        }
    },
    
    nextPage() {
        const maxPage = Math.ceil(this.total / this.pageSize) - 1;
        if (this.currentPage < maxPage) {
            this.currentPage++;
            this.loadUsers();
        }
    },
    
    search() {
        this.searchKeyword = document.getElementById('searchInput').value.trim();
        this.currentPage = 0;
        this.loadUsers();
    },
    
    // åˆ›å»ºç”¨æˆ·ç›¸å…³
    openCreateModal() {
        document.getElementById('modalTitle').textContent = 'æ·»åŠ ç”¨æˆ·';
        document.getElementById('editUserId').value = '';
        document.getElementById('userEmail').value = '';
        document.getElementById('userPhone').value = '';
        document.getElementById('userNickname').value = '';
        document.getElementById('userPassword').value = '';
        document.getElementById('userRole').value = 'user';
        document.getElementById('userStatus').value = 'active';
        document.getElementById('userBalance').value = '0';
        
        document.getElementById('passwordGroup').querySelector('label').textContent = 'å¯†ç  *';
        document.getElementById('balanceGroup').style.display = 'block';
        
        document.getElementById('userModal').classList.add('active');
    },
    
    async editUser(userId) {
        try {
            const response = await AuthManager.authenticatedFetch(
                `${AuthManager.apiBaseUrl}/admin/users/${userId}`
            );
            const data = await response.json();
            
            if (data.success) {
                const user = data.user;
                
                document.getElementById('modalTitle').textContent = 'ç¼–è¾‘ç”¨æˆ·';
                document.getElementById('editUserId').value = user.id;
                document.getElementById('userEmail').value = user.email || '';
                document.getElementById('userPhone').value = user.phone || '';
                document.getElementById('userNickname').value = user.nickname || '';
                document.getElementById('userPassword').value = '';
                document.getElementById('userRole').value = user.role;
                document.getElementById('userStatus').value = user.status;
                
                document.getElementById('passwordGroup').querySelector('label').textContent = 'å¯†ç ï¼ˆç•™ç©ºä¸ä¿®æ”¹ï¼‰';
                document.getElementById('balanceGroup').style.display = 'none';
                
                document.getElementById('userModal').classList.add('active');
            }
        } catch (error) {
            console.error('[AdminUsers] è·å–ç”¨æˆ·è¯¦æƒ…å¤±è´¥:', error);
            alert('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
        }
    },
    
    closeModal() {
        document.getElementById('userModal').classList.remove('active');
    },
    
    async saveUser() {
        const userId = document.getElementById('editUserId').value;
        const isEdit = !!userId;
        
        const email = document.getElementById('userEmail').value.trim();
        const phone = document.getElementById('userPhone').value.trim();
        const nickname = document.getElementById('userNickname').value.trim();
        const password = document.getElementById('userPassword').value;
        const role = document.getElementById('userRole').value;
        const status = document.getElementById('userStatus').value;
        const balance = parseInt(document.getElementById('userBalance').value) || 0;
        
        if (!email) {
            alert('è¯·è¾“å…¥é‚®ç®±');
            return;
        }
        
        if (!isEdit && !password) {
            alert('è¯·è¾“å…¥å¯†ç ');
            return;
        }
        
        const btn = document.getElementById('btnSaveUser');
        btn.disabled = true;
        btn.textContent = 'ä¿å­˜ä¸­...';
        
        try {
            let url, method;
            const body = { email, phone, nickname, role, status };
            
            if (password) body.password = password;
            
            if (isEdit) {
                url = `${AuthManager.apiBaseUrl}/admin/users/${userId}`;
                method = 'PUT';
            } else {
                url = `${AuthManager.apiBaseUrl}/admin/users`;
                method = 'POST';
                body.balance = balance;
            }
            
            const response = await AuthManager.authenticatedFetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            
            const data = await response.json();
            
            if (data.success) {
                this.closeModal();
                this.loadUsers();
                alert(isEdit ? 'ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°' : 'ç”¨æˆ·åˆ›å»ºæˆåŠŸ');
            } else {
                alert(data.message || data.error || 'æ“ä½œå¤±è´¥');
            }
        } catch (error) {
            console.error('[AdminUsers] ä¿å­˜ç”¨æˆ·å¤±è´¥:', error);
            alert('æ“ä½œå¤±è´¥: ' + error.message);
        } finally {
            btn.disabled = false;
            btn.textContent = 'ä¿å­˜';
        }
    },
    
    async deleteUser(userId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥ç”¨æˆ·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œç”¨æˆ·çš„æ‰€æœ‰æ•°æ®éƒ½å°†è¢«åˆ é™¤ã€‚')) return;
        
        try {
            const response = await AuthManager.authenticatedFetch(
                `${AuthManager.apiBaseUrl}/admin/users/${userId}`,
                { method: 'DELETE' }
            );
            
            const data = await response.json();
            
            if (data.success) {
                this.loadUsers();
                alert('ç”¨æˆ·å·²åˆ é™¤');
            } else {
                alert(data.message || data.error || 'åˆ é™¤å¤±è´¥');
            }
        } catch (error) {
            console.error('[AdminUsers] åˆ é™¤ç”¨æˆ·å¤±è´¥:', error);
            alert('åˆ é™¤å¤±è´¥: ' + error.message);
        }
    },
    
    // ç‚¹æ•°è°ƒæ•´ç›¸å…³
    openPointsModal(userId) {
        const user = this.users.find(u => u.id === userId);
        if (!user) return;
        
        document.getElementById('pointsUserId').value = userId;
        document.getElementById('pointsUserInfo').value = `${user.nickname || 'æœªè®¾ç½®'} (${user.email || user.phone || 'ID: ' + user.id})`;
        document.getElementById('pointsCurrentBalance').value = `${user.balance || 0} MP`;
        document.getElementById('pointsAction').value = 'add';
        document.getElementById('pointsAmount').value = '0';
        document.getElementById('pointsReason').value = '';
        
        this.updatePointsPreview();
        
        document.getElementById('pointsModal').classList.add('active');
    },
    
    closePointsModal() {
        document.getElementById('pointsModal').classList.remove('active');
    },
    
    updatePointsPreview() {
        const userId = document.getElementById('pointsUserId').value;
        const user = this.users.find(u => u.id === parseInt(userId));
        if (!user) return;
        
        const currentBalance = user.balance || 0;
        const action = document.getElementById('pointsAction').value;
        const amount = parseInt(document.getElementById('pointsAmount').value) || 0;
        
        let newBalance;
        if (action === 'add') {
            newBalance = currentBalance + amount;
        } else if (action === 'subtract') {
            newBalance = Math.max(0, currentBalance - amount);
        } else {
            newBalance = amount;
        }
        
        document.getElementById('pointsNewBalance').value = `${newBalance} MP`;
    },
    
    async adjustPoints() {
        const userId = document.getElementById('pointsUserId').value;
        const action = document.getElementById('pointsAction').value;
        const amount = parseInt(document.getElementById('pointsAmount').value) || 0;
        const reason = document.getElementById('pointsReason').value.trim();
        
        if (amount <= 0 && action !== 'set') {
            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„è°ƒæ•´æ•°é‡');
            return;
        }
        
        if (!reason) {
            alert('è¯·è¾“å…¥è°ƒæ•´åŸå› ');
            return;
        }
        
        try {
            let url, body;
            
            if (action === 'set') {
                url = `${AuthManager.apiBaseUrl}/admin/users/${userId}/set-balance`;
                body = { balance: amount, reason };
            } else {
                url = `${AuthManager.apiBaseUrl}/admin/users/${userId}/adjust-balance`;
                const adjustAmount = action === 'add' ? amount : -amount;
                body = { amount: adjustAmount, reason };
            }
            
            const response = await AuthManager.authenticatedFetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            
            const data = await response.json();
            
            if (data.success) {
                this.closePointsModal();
                this.loadUsers();
                alert(`ç‚¹æ•°è°ƒæ•´æˆåŠŸï¼š${data.balance_before} â†’ ${data.balance_after} MP`);
            } else {
                alert(data.message || data.error || 'è°ƒæ•´å¤±è´¥');
            }
        } catch (error) {
            console.error('[AdminUsers] è°ƒæ•´ç‚¹æ•°å¤±è´¥:', error);
            alert('è°ƒæ•´å¤±è´¥: ' + error.message);
        }
    }
};

// å¯¼å‡ºåˆ°å…¨å±€
window.AdminUsers = AdminUsers;
</script>


