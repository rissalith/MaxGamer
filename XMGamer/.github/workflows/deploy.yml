name: Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
      
      - name: Update version timestamp
        run: |
          echo "更新版本时间戳..."
          BUILD_TIMESTAMP=$(date +%s)
          echo "BUILD_TIMESTAMP: $BUILD_TIMESTAMP"
          
          # 替换 version.js 中的占位符
          sed -i "s/__BUILD_TIMESTAMP__/$BUILD_TIMESTAMP/g" XMGamer/frontend/js/version.js
          
          echo "版本时间戳已更新"
      
      - name: Deploy to server
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          echo "开始部署到服务器..."
          
          # 创建临时目录
          ssh $SERVER_USER@$SERVER_IP "mkdir -p /tmp/frameworker-deploy"
          
          # 使用rsync同步文件（排除不需要的文件）
          rsync -avz --delete \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='.env' \
            --exclude='venv' \
            --exclude='*.db' \
            ./ $SERVER_USER@$SERVER_IP:/tmp/frameworker-deploy/
          
          # 在服务器上执行部署脚本
          ssh $SERVER_USER@$SERVER_IP << 'ENDSSH'
            set -e
            
            echo "创建FrameWorker目录（如果不存在）..."
            mkdir -p /var/www/FrameWorker
            
            echo "备份Nginx配置..."
            if [ -d "/var/www/FrameWorker/nginx" ]; then
              cp -r /var/www/FrameWorker/nginx /tmp/nginx-backup-$(date +%Y%m%d_%H%M%S)
              echo "Nginx配置已备份"
            fi
            
            echo "同步新文件..."
            rsync -av --delete \
              --exclude='nginx/' \
              --exclude='venv/' \
              --exclude='*.db' \
              --exclude='__pycache__/' \
              /tmp/frameworker-deploy/ /var/www/FrameWorker/
            
            echo "恢复Nginx配置（如果需要）..."
            if [ ! -d "/var/www/FrameWorker/nginx/conf.d" ]; then
              mkdir -p /var/www/FrameWorker/nginx/conf.d
              # 如果配置文件不存在，从备份恢复或使用默认配置
              if [ -f "/var/www/FrameWorker/nginx-xmframer.conf" ]; then
                cp /var/www/FrameWorker/nginx-xmframer.conf /var/www/FrameWorker/nginx/conf.d/xmgamer.conf
                echo "已恢复Nginx配置"
              fi
            fi
            
            cd /var/www/FrameWorker
            
            echo "设置权限..."
            chown -R www-data:www-data /var/www/FrameWorker/XMGamer
            
            echo "安装Python依赖..."
            cd XMGamer/backend
            if [ ! -d "venv" ]; then
              python3 -m venv venv
            fi
            source venv/bin/activate
            pip install -r requirements.txt
            
            echo "重启Docker容器..."
            docker restart xmgamer-gateway || echo "警告: Nginx容器重启失败"
            docker restart xmgamer-api || echo "警告: API容器重启失败"
            
            echo "清理临时文件..."
            rm -rf /tmp/frameworker-deploy
            
            echo "部署完成！"
          ENDSSH
          
          echo "✅ 部署成功完成！"
      
      - name: Verify deployment
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          echo "验证部署状态..."
          ssh $SERVER_USER@$SERVER_IP "systemctl status frameworker --no-pager || true"